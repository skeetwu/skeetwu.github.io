<!DOCTYPE html>
<html class="no-js" lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>自动下载七牛日志CDN日志 | 攻城狮小武</title>
  <meta name="viewport" content="width=1430, initial-scale=1">

  <link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="攻城狮小武 &raquo; Feed" href="/feed" />
<link rel="alternate" type="application/rss+xml" title="攻城狮小武 &raquo; 评论Feed" href="/comments/feed" />
<link rel="alternate" type="application/rss+xml" title="攻城狮小武 &raquo; 自动下载七牛日志CDN日志评论Feed" href="/archives/275.html/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.tiaobug.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.8.12"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,56826,8203,55356,56819),0,0),c=j.toDataURL(),b!==c&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55358,56794,8205,9794,65039),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55358,56794,8203,9794,65039),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='crayon-css'  href='/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-tomorrow-night-css'  href='/wp-content/plugins/crayon-syntax-highlighter/themes/tomorrow-night/tomorrow-night.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='dw_timeline_main-css'  href='/wp-content/themes/dw-timeline/assets/css/main.css?ver=6c39f42987ae297a5a21e2bb35bf3402' type='text/css' media='all' />
<link rel='stylesheet' id='dw_timeline_style-css'  href='/wp-content/themes/dw-timeline/style.css?ver=c1a58eb4baaf24c3771085df3d54ff8d' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"http:\/\/www.tiaobug.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript' src='/wp-content/themes/dw-timeline/assets/js/vendor/modernizr-2.7.0.min.js'></script>
<script type='text/javascript' src='/wp-content/themes/dw-timeline/assets/js/vendor/nivo-lightbox.min.js'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='TheFuck，一款够炫酷的命令行提示工具' href='/archives/272.html' />
<link rel='next' title='115的云盘续费已经从45涨到320，表示得告别115了。我担心续费，115还能不能撑到明年。' href='/archives/279.html' />
<meta name="generator" content="WordPress 4.8.12" />
<link rel="canonical" href="/archives/275.html" />
<link rel='shortlink' href='/?p=275' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Farchives%2F275.html" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Farchives%2F275.html&#038;format=xml" />
<link rel="shortcut icon" href="/wp-content/uploads/2017/12/WP3-副本.jpg">    <style>
    
        
    
          .banner hgroup:after {
        background: none;
      }   
    
    </style>    
    <link rel="icon" href="/wp-content/uploads/2017/12/cropped-WP3-副本-32x32.jpg" sizes="32x32" />
<link rel="icon" href="/wp-content/uploads/2017/12/cropped-WP3-副本-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="/wp-content/uploads/2017/12/cropped-WP3-副本-180x180.jpg" />
<meta name="msapplication-TileImage" content="http://www.tiaobug.com/wp-content/uploads/2017/12/cropped-WP3-副本-270x270.jpg" />
		<style type="text/css" id="wp-custom-css">
			/*
您可以在此处加入您的CSS。

点击上方的帮助图标来了解更多。
*/
.wrap {
    padding-bottom: 100px;
}
.bottom-info{
    clear: both;
    position: fixed;
    bottom: 0px;
    background-color: #e5e5e5;
    z-index: 1000;
    text-align: center;
    width: 100%;
}		</style>
	  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?d68c66f0010a97131e967e4bab927275";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body class="post-template-default single single-post postid-275 single-format-standard">
    
<header class="banner no-cover" role="banner">
  <div class="header-inner">
      <nav class="nav-main" role="navigation">
        <div class="container">
                </div>
      </nav>
        </div>
</header>  <div class="wrap container" role="document">
    <div class="content row">
      <main class="main col-sm-8 col-sm-offset-2" role="main">
          <article class="post-275 post type-post status-publish format-standard hentry category-uncategorized dwtl normal">
    <header>
      <h1 class="entry-title">自动下载七牛日志CDN日志</h1>
      <div class="entry-meta">
	<span class="entry-author">
		<img alt='' src='http://2.gravatar.com/avatar/ea79cc3d71ad78055cfa388b491ac3d4?s=32&#038;d=retro&#038;r=g' srcset='http://2.gravatar.com/avatar/ea79cc3d71ad78055cfa388b491ac3d4?s=64&amp;d=retro&amp;r=g 2x' class='avatar avatar-32 photo' height='32' width='32' />		<span class="byline author vcard">
			By <a href="/archives/author/admin" rel="author" class="fn">武鹏</a>
		</span>
	</span>
	<span class="sep">&bull;</span>
	<span class="entry-date">On <a href="/archives/275.html"><time class="published" datetime="2017-06-22T21:18:32+00:00">2017年6月22日</time></a></span>
	<span class="sep">&bull;</span>
	<span class="cat-links">In 
	<a href="/archives/category/uncategorized" rel="category tag">技术总结分享</a></span>
</div>
    </header>
    <div class="entry-content">
      <p>最近在做日志分析，发现有些静态页面的内容是携带重要参数的，七牛的cdn提供了日志下载接口，但是没有完全自动化。</p>
<p>跟客服沟通后，确实是没有，没办法只能自己造个轮子，决定把七牛的log拿过来，自己处理分析。</p>
<p>关于七牛日志的一些说明和描述在这里</p>
<p>https://developer.qiniu.com/fusion/api/1226/download-the-log</p>
<p>所以最好是写个脚本，每天中午十一点自动执行。单纯的shell脚本无法全部完成，所以还得结合一些python。不过关于日志下载列表这块，七牛的sdk有个坑，待会说。</p>
<p>做好的shell脚本：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5df7170b3c41d745879459" class="crayon-syntax crayon-theme-tomorrow-night crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
#!/bin/sh

#retrive yesterday logs from qiniu cdn every 11:00 am
#see https://developer.qiniu.com/fusion/api/1226/download-the-log

yesterday=`date -d -1day +%Y-%m-%d`  

if [ ! -z "$1" ] ;then
  yesterday="$1"
else
  echo "no input, user yesterday!"
fi


echo $yesterday
echo "--------------  $yesterday 's logs begin to collect"
cd /opt/qiniu_logs/logs/
rm -rf *.log

python /opt/qiniu_logs/downloadlogs.py $yesterday
echo "-------------- create download shell "

while read line
do
$line
done &lt; '/opt/qiniu_logs/target.list'
gzip -d *.gz
for i in `ls`; do mv -f $i `echo $i".log"`; done
echo "-------------- download and unzip "

java -jar /opt/qiniu_logs/a.jar demo.LogCollecter</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums" data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-2">2</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-4">4</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-6">6</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-8">8</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-10">10</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-12">12</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-14">14</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-16">16</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-18">18</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-20">20</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-22">22</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-24">24</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-26">26</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-28">28</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c41d745879459-30">30</div><div class="crayon-num" data-line="crayon-5df7170b3c41d745879459-31">31</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5df7170b3c41d745879459-1"><span class="crayon-p">#!/bin/sh</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-2">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-3"><span class="crayon-c">#retrive yesterday logs from qiniu cdn every 11:00 am</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-4"><span class="crayon-c">#see https://developer.qiniu.com/fusion/api/1226/download-the-log</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-6"><span class="crayon-v">yesterday</span><span class="crayon-o">=</span><span class="crayon-sy">`</span><span class="crayon-r">date</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1day</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-o">%</span><span class="crayon-v">Y</span><span class="crayon-o">-</span><span class="crayon-o">%</span><span class="crayon-v">m</span><span class="crayon-o">-</span><span class="crayon-o">%</span><span class="crayon-v">d</span><span class="crayon-sy">`</span><span class="crayon-h">&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-8"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">z</span><span class="crayon-h"> </span><span class="crayon-s">"$1"</span><span class="crayon-h"> </span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">;</span><span class="crayon-st">then</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">yesterday</span><span class="crayon-o">=</span><span class="crayon-s">"$1"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-10"><span class="crayon-st">else</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-s">"no input, user yesterday!"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-12"><span class="crayon-st">fi</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-14">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-15"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-v">$yesterday</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-16"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-s">"--------------&nbsp;&nbsp;$yesterday 's logs begin to collect"</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-17"><span class="crayon-r">cd</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">opt</span><span class="crayon-o">/</span><span class="crayon-v">qiniu_logs</span><span class="crayon-o">/</span><span class="crayon-v">logs</span><span class="crayon-o">/</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-18"><span class="crayon-r">rm</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">rf</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">.log</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-20"><span class="crayon-v">python</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">opt</span><span class="crayon-o">/</span><span class="crayon-v">qiniu_logs</span><span class="crayon-o">/</span><span class="crayon-v">downloadlogs</span><span class="crayon-e">.py</span><span class="crayon-h"> </span><span class="crayon-v">$yesterday</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-21"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-s">"-------------- create download shell "</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-22">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-23"><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-r">read</span><span class="crayon-h"> </span><span class="crayon-e">line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-24"><span class="crayon-st">do</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-25"><span class="crayon-v">$line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-26"><span class="crayon-st">done</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-s">'/opt/qiniu_logs/target.list'</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-27"><span class="crayon-v">gzip</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-e">.gz</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-28"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-r">ls</span><span class="crayon-sy">`</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">do</span><span class="crayon-h"> </span><span class="crayon-r">mv</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">$i</span><span class="crayon-h"> </span><span class="crayon-sy">`</span><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-v">$i</span><span class="crayon-s">".log"</span><span class="crayon-sy">`</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-st">done</span></div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-29"><span class="crayon-r">echo</span><span class="crayon-h"> </span><span class="crayon-s">"-------------- download and unzip "</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c41d745879459-30">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c41d745879459-31"><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">jar</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">opt</span><span class="crayon-o">/</span><span class="crayon-v">qiniu_logs</span><span class="crayon-o">/</span><span class="crayon-v">a</span><span class="crayon-e">.jar</span><span class="crayon-h"> </span><span class="crayon-v">demo</span><span class="crayon-e">.LogCollecter</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0042 seconds] -->
<p>&nbsp;</p>
<p>调用的python脚本：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5df7170b3c42b477381221" class="crayon-syntax crayon-theme-tomorrow-night crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
# -*- coding: utf-8 -*-
import qiniu
import requests
from qiniu import Auth
from qiniu import CdnManager
from qiniu import http
from qiniu import create_timestamp_anti_leech_url
import time
import json
import sys


# 账户ak，sk
access_key = 'ZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'
secret_key = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'

auth = qiniu.Auth(access_key=access_key, secret_key=secret_key)
cdn_manager = CdnManager(auth)

def print_result(result):
    if result[0] is not None:
        print(type(result[0]))
        print(result[0])

    print(type(result[1]))
    print(result[1])


domains = ['XXXXXX.iuu.travel', 'YYYYYYYYY.iuu.travel']


# 获取日志列表
#print('获取日志列表')
log_date =sys.argv[1] 
log_data = cdn_manager.get_log_list_data(domains, log_date)
dict = log_data[0]
urls1=dict["data"]["xxxxxxxx.iuu.travel"]
urls2=dict["data"]["yyyyyyyy.iuu.travel"]

f = open('/opt/qiniu_logs/target.list', 'w')
num=1
for i in urls1:
  a=i["url"].replace("&amp;","\&amp;")
  S="wget -q "+a+" -O app_"+log_date+"_"+str(num)+".gz \n"
  f.write(S)
  num=num+1
  
num=1
for i in urls2:
  a=i["url"].replace("&amp;","\&amp;")
  S="wget -q "+a+" -O api_"+log_date+"_"+str(num)+".gz \n"
  f.write(S)
  num=num+1

f.close</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums" data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-2">2</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-4">4</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-6">6</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-8">8</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-10">10</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-12">12</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-14">14</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-16">16</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-18">18</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-20">20</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-22">22</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-24">24</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-26">26</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-28">28</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-30">30</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-32">32</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-34">34</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-36">36</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-38">38</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-40">40</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-42">42</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-44">44</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-46">46</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-48">48</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-50">50</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-52">52</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5df7170b3c42b477381221-54">54</div><div class="crayon-num" data-line="crayon-5df7170b3c42b477381221-55">55</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5df7170b3c42b477381221-1"><span class="crayon-c"># -*- coding: utf-8 -*-</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-2"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">qiniu</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-3"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">requests</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-4"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">qiniu </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Auth</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-5"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">qiniu </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">CdnManager</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-6"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">qiniu </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">http</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-7"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">qiniu </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">create_timestamp_anti_leech_url</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-8"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k">time</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-9"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k">json</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-10"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-k">sys</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-12">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-13"><span class="crayon-c"># 账户ak，sk</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-14"><span class="crayon-v">access_key</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'ZXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-15"><span class="crayon-v">secret_key</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-16">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-17"><span class="crayon-v">auth</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">qiniu</span><span class="crayon-sy">.</span><span class="crayon-e">Auth</span><span class="crayon-sy">(</span><span class="crayon-v">access_key</span><span class="crayon-o">=</span><span class="crayon-v">access_key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">secret_key</span><span class="crayon-o">=</span><span class="crayon-v">secret_key</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-18"><span class="crayon-v">cdn_manager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CdnManager</span><span class="crayon-sy">(</span><span class="crayon-v">auth</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-20"><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">print_result</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-k">print</span><span class="crayon-sy">(</span><span class="crayon-k">type</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-k">print</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-24">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-k">print</span><span class="crayon-sy">(</span><span class="crayon-k">type</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-k">print</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-27">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-28">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-29"><span class="crayon-v">domains</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'XXXXXX.iuu.travel'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'YYYYYYYYY.iuu.travel'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-30">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-31">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-32"><span class="crayon-c"># 获取日志列表</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-33"><span class="crayon-c">#print('获取日志列表')</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-34"><span class="crayon-v">log_date</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-k">sys</span><span class="crayon-sy">.</span><span class="crayon-v">argv</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-35"><span class="crayon-v">log_data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">cdn_manager</span><span class="crayon-sy">.</span><span class="crayon-e">get_log_list_data</span><span class="crayon-sy">(</span><span class="crayon-v">domains</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">log_date</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-36"><span class="crayon-k">dict</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">log_data</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-37"><span class="crayon-v">urls1</span><span class="crayon-o">=</span><span class="crayon-k">dict</span><span class="crayon-sy">[</span><span class="crayon-s">"data"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">"xxxxxxxx.iuu.travel"</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-38"><span class="crayon-v">urls2</span><span class="crayon-o">=</span><span class="crayon-k">dict</span><span class="crayon-sy">[</span><span class="crayon-s">"data"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-s">"yyyyyyyy.iuu.travel"</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-39">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-40"><span class="crayon-v">f</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k">open</span><span class="crayon-sy">(</span><span class="crayon-s">'/opt/qiniu_logs/target.list'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-41"><span class="crayon-v">num</span><span class="crayon-o">=</span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-42"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">urls1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-43"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">a</span><span class="crayon-o">=</span><span class="crayon-v">i</span><span class="crayon-sy">[</span><span class="crayon-s">"url"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;"</span><span class="crayon-sy">,</span><span class="crayon-s">"\&amp;"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-44"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">S</span><span class="crayon-o">=</span><span class="crayon-s">"wget -q "</span><span class="crayon-o">+</span><span class="crayon-v">a</span><span class="crayon-o">+</span><span class="crayon-s">" -O app_"</span><span class="crayon-o">+</span><span class="crayon-v">log_date</span><span class="crayon-o">+</span><span class="crayon-s">"_"</span><span class="crayon-o">+</span><span class="crayon-k">str</span><span class="crayon-sy">(</span><span class="crayon-v">num</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-s">".gz \n"</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-45"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">S</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-46"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">num</span><span class="crayon-o">=</span><span class="crayon-v">num</span><span class="crayon-o">+</span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-47"><span class="crayon-h">&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-48"><span class="crayon-v">num</span><span class="crayon-o">=</span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-49"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">urls2</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-50"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">a</span><span class="crayon-o">=</span><span class="crayon-v">i</span><span class="crayon-sy">[</span><span class="crayon-s">"url"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">replace</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;"</span><span class="crayon-sy">,</span><span class="crayon-s">"\&amp;"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-51"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">S</span><span class="crayon-o">=</span><span class="crayon-s">"wget -q "</span><span class="crayon-o">+</span><span class="crayon-v">a</span><span class="crayon-o">+</span><span class="crayon-s">" -O api_"</span><span class="crayon-o">+</span><span class="crayon-v">log_date</span><span class="crayon-o">+</span><span class="crayon-s">"_"</span><span class="crayon-o">+</span><span class="crayon-k">str</span><span class="crayon-sy">(</span><span class="crayon-v">num</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-s">".gz \n"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-52"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">S</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-53"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">num</span><span class="crayon-o">=</span><span class="crayon-v">num</span><span class="crayon-o">+</span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5df7170b3c42b477381221-54">&nbsp;</div><div class="crayon-line" id="crayon-5df7170b3c42b477381221-55"><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-v">close</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0100 seconds] -->
<p>python脚本主要的工作是把七牛日志的url列表获取到。</p>
<p>url格式：</p>
<p>http://fusionlog.qiniu.com/v2/app.iuu.travel_2017-06-21-08_part-00000.gz?e=1529561090\&#038;token=557TpseUM8ovpfUhaw8gfa2DQ0104ZScM-BTIcBx:JJyYu9oG6r44TUalBz_-1mBTuzM</p>
<p>拼接成一个wget的语句写入到文本文件中，但是这个地方一定要注意生成的时候 wget的url要转移?，这个坑搞了好久才跳出来，调试时明明在本地可以，到服务器上就不行了，后来才发现服务器的报错提示无授权，才发现token传的不对。</p>
<p>处理后的格式：</p>
<p>wget -q http://fusionlog.qiniu.com/v2/app.iuu.travel_2017-06-21-08_part-00000.gz?e=1529561090\&amp;token=557TpseUM8ovpfUhaw8gfa2DQ0104ZScM-BTIcBx:JJyYu9oG6r44TUal<br />
Bz_-1mBTuzM -O app_2017-06-21_9.gz</p>
<p>最后补充一点，这个地方的七牛的python版本sdk，pip安装的有个bug，issue在这里https://github.com/qiniu/python-sdk/issues/264</p>
<p>直接下载源码安装就能搞定这个问题了。</p>
<p>&nbsp;</p>
<p>这样就可以在七牛服务器上定期的下载日志了，接下来是手动处理还是代码处理，还是直接导入到数据库，就看自己需求了。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
          </div>
    <footer>
          </footer>
  </article>
  
	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/archives/275.html#respond" style="display:none;">取消回复</a></small></h3><p class="must-log-in">要发表评论，您必须先<a href="/wp-login.php?redirect_to=http%3A%2F%2F%2Farchives%2F275.html">登录</a>。</p>	</div><!-- #respond -->
	      </main>
    </div>
  </div>
  <div class="bottom-info">
<div style="font-size: 12px;text-align: center;padding:28px 0 0 0">@娱乐性质的个人Blog，技术文章居多，偶发性会有深思文，请谨慎关注，随意转发，如果可以请把出处写上
</div>
<div style="font-size: 10px;text-align: center;padding:5px 0 0 0">联系我，个人微博，Twitter，FaceBook等等各种账号，请@tiaobug，Email: i@tiaobug.com
</div>
<div style="font-size: 12px;text-align: center;padding:5px 0 12px 0 ">鲁ICP备17013530号
</div>
</div><script type='text/javascript' src='/wp-includes/js/comment-reply.min.js?ver=4.8.12'></script>
<script type='text/javascript' src='/wp-content/themes/dw-timeline/assets/js/vendor/jquery.infinitescroll.min.js?ver=4.8.12'></script>
<script type='text/javascript' src='/wp-content/themes/dw-timeline/assets/js/vendor/bootstrap-3.0.3.min.js?ver=4.8.12'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var dwtl = {"template_directory_uri":"http:\/\/www.tiaobug.com\/wp-content\/themes\/dw-timeline"};
var infinitescroll = {"page":"page","the_end":"the end"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/themes/dw-timeline/assets/js/scripts.js?ver=4.8.12'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.8.12'></script>

</body>
</html>
